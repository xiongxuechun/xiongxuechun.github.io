<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="keywords" content="自我提升,效率提升,开源工具,学习笔记" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #252232);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://www.codenook.cn/%E6%A1%86%E6%9E%B6/Spring/IOC/Bean%E5%AE%9E%E4%BE%8B%E5%8C%96(%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%AD%89).html"><meta property="og:site_name" content="知识体系"><meta property="og:title" content="# Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)"><meta property="og:description" content="# Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等) 上文，我们看了IOC设计要点和设计结构；以及Spring如何实现将资源配置（以xml配置为例）通过加载，解析，生成BeanDefination并注册到IoC容器中的；容器中存放的是Bean的定义即BeanDefinition放到beanDefinition..."><meta property="og:type" content="article"><meta property="og:image" content="https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-74.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-09-04T14:55:43.000Z"><meta property="article:author" content="XIONG XUECHUN"><meta property="article:modified_time" content="2024-09-04T14:55:43.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"# Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)","image":["https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-74.png","https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-100.png","https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-102.png"],"dateModified":"2024-09-04T14:55:43.000Z","author":[{"@type":"Person","name":"XIONG XUECHUN","url":"https://www.codenook.cn/","email":"15293191747@163.com"}]}</script><link rel="alternate" type="application/atom+xml" href="https://www.codenook.cn/atom.xml" title="知识体系 Atom Feed"><link rel="alternate" type="application/json" href="https://www.codenook.cn/feed.json" title="知识体系 JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://www.codenook.cn/rss.xml" title="知识体系 RSS Feed"><link rel="icon" href="/logo-favicon.png"><title># Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等) | 知识体系</title><meta name="description" content="# Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等) 上文，我们看了IOC设计要点和设计结构；以及Spring如何实现将资源配置（以xml配置为例）通过加载，解析，生成BeanDefination并注册到IoC容器中的；容器中存放的是Bean的定义即BeanDefinition放到beanDefinition...">
    <link rel="stylesheet" href="/assets/css/styles.0d96db94.css">
    <link rel="preload" href="/assets/js/runtime~app.b1768b64.js" as="script"><link rel="preload" href="/assets/css/styles.0d96db94.css" as="style"><link rel="preload" href="/assets/js/5755.cf3ac905.js" as="script"><link rel="preload" href="/assets/js/app.a0e07665.js" as="script">
    
    <!-- 统计代码区域-->
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/logo.png" alt><!----><span class="vp-site-name hide-in-pad">知识体系</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="导航"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:bars" width="1em" height="1em"></iconify-icon><!--]-->导航<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog.html" aria-label="个人博客"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:blog" width="1em" height="1em"></iconify-icon><!--]-->个人博客<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Java"><!--[--><!---->Java<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Java 基础</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/Java%20%E5%9F%BA%E7%A1%80/" aria-label="面向对象基础"><!---->面向对象基础<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="基础知识体系"><!---->基础知识体系<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Java进阶 - 集合框架</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java 集合框架详解"><!---->Java 集合框架详解<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Java进阶 - 并发</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java 并发知识体系"><!---->Java 并发知识体系<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java 并发理论基础"><!---->Java 并发理论基础<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java 并发线程"><!---->Java 并发线程<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="J.U.C 知识体系"><!---->J.U.C 知识体系<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java 并发编程实战"><!---->Java 并发编程实战<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Java进阶 - IO模型</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="Java IO知识体系"><!---->Java IO知识体系<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Java进阶 - JVM</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/Java/apps/" aria-label="JVM 知识体系"><!---->JVM 知识体系<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="算法"><!--[--><!---->算法<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">算法基础</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/" aria-label="数据结构知识体系"><!---->数据结构知识体系<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/算法/apps/topic/" aria-label="常见算法"><!---->常见算法<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">AI 算法</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/算法/apps/topic/" aria-label="图像算法"><!---->图像算法<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/算法/apps/topic/" aria-label="NLP"><!---->NLP<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="框架"><!--[--><!---->框架<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Spring 框架知识体系</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/%E6%A1%86%E6%9E%B6/Spring/" aria-label="Spring 框架知识体系"><!---->Spring 框架知识体系<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/%E6%A1%86%E6%9E%B6/Spring/AOP/" aria-label="AOP"><!---->AOP<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link route-link-active auto-link" href="/%E6%A1%86%E6%9E%B6/Spring/IOC/" aria-label="IOC"><!---->IOC<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">Spring Boot框架</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/框架/apps/topic/" aria-label="集成"><!---->集成<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/框架/apps/topic/" aria-label="特性"><!---->特性<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="中间件"><!--[--><!---->中间件<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">消息队列</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="Kafka"><!---->Kafka<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="RocketMQ"><!---->RocketMQ<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="数据库"><!--[--><!---->数据库<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">SQL 数据库</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MySQL 数据库"><!---->MySQL 数据库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">No SQL 数据库</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MongoDB"><!---->MongoDB<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="Redis"><!---->Redis<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="架构设计"><!--[--><!---->架构设计<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">分布式系统</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MySQL 数据库"><!---->MySQL 数据库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">微服务系统架构设计</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="项目实战"><!--[--><!---->项目实战<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">电商项目</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MySQL 数据库"><!---->MySQL 数据库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">支付项目</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="工具"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:toolbox" width="1em" height="1em"></iconify-icon>工具<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://www.aishort.top/" aria-label="ChatGPT SC" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:bolt" width="1em" height="1em"></iconify-icon><!--]-->ChatGPT SC<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://prompt.newzone.top/" aria-label="IMGPrompt" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:image" width="1em" height="1em"></iconify-icon><!--]-->IMGPrompt<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://tools.newzone.top/json-translate" aria-label="多语言翻译" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:language" width="1em" height="1em"></iconify-icon><!--]-->多语言翻译<!----></a></li><li class="vp-dropdown-item"><a class="auto-link external-link" href="https://nav.newzone.top/" aria-label="工具收藏" rel="noopener noreferrer" target="_blank"><!--[--><iconify-icon class="font-icon icon" style="" mode="style" inline icon="fa6-solid:bars" width="1em" height="1em"></iconify-icon><!--]-->工具收藏<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="产品|团队 思维"><!--[--><!---->产品|团队 思维<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">技术之外</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MySQL 数据库"><!---->MySQL 数据库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">产品思考</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">个人成长</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="关于"><!--[--><!---->关于<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">关于作者</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="MySQL 数据库"><!---->MySQL 数据库<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">读书分享</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">更新历史</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/family/apps/topic/" aria-label="ElasticSearch"><!---->ElasticSearch<!----></a></li></ul></li></ul></button></div></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!--[--><button type="button" class="search-pro-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">搜索</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/xiongxuechun" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">Spring</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/%E6%A1%86%E6%9E%B6/Spring/Spring%E6%A1%86%E6%9E%B6%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB%E8%AF%A6%E8%A7%A3.html" aria-label="# ♥Spring框架知识体系详解♥"><!----># ♥Spring框架知识体系详解♥<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">AOP</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">IOC</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/%E6%A1%86%E6%9E%B6/Spring/IOC/Bean%E5%AE%9E%E4%BE%8B%E5%8C%96(%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F_%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%AD%89).html" aria-label="# Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)"><!----># Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)<!----></a></li></ul></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!----># Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)</h1><div class="page-info"><!----><!----><span class="page-word-info" aria-label="字数🔠" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon" name="word"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 5666 字</span><meta property="wordCount" content="5666"></span><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 19 分钟</span><meta property="timeRequired" content="PT19M"></span><!----></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#引入"># 引入</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#beanfactory中getbean的主体思路"># BeanFactory中getBean的主体思路</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#初步的思考"># 初步的思考</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring中getbean的主体思路"># Spring中getBean的主体思路</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#重点-spring如何解决循环依赖问题"># 重点：Spring如何解决循环依赖问题</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring单例模式下的属性依赖"># Spring单例模式下的属性依赖</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring为何不能解决非单例属性之外的循环依赖"># Spring为何不能解决非单例属性之外的循环依赖？</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#那么其它循环依赖如何解决"># 那么其它循环依赖如何解决？</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#重点-spring中bean的生命周期"># 重点：Spring中Bean的生命周期</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring-bean生命周期流程"># Spring Bean生命周期流程</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring-bean生命周期案例"># Spring Bean生命周期案例</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#spring-bean生命周期源码"># Spring Bean生命周期源码</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#参考文章"># 参考文章</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="spring进阶-spring-ioc实现原理详解之bean实例化-生命周期-循环依赖等" tabindex="-1"><a class="header-anchor" href="#spring进阶-spring-ioc实现原理详解之bean实例化-生命周期-循环依赖等"><span><a href="#spring%E8%BF%9B%E9%98%B6-spring-ioc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E4%B9%8Bbean%E5%AE%9E%E4%BE%8B%E5%8C%96-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%AD%89">#</a> Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)</span></a></h1><blockquote><p>上文，我们看了IOC设计要点和设计结构；以及Spring如何实现将资源配置（以xml配置为例）通过加载，解析，生成BeanDefination并注册到IoC容器中的；容器中存放的是Bean的定义即BeanDefinition放到beanDefinitionMap中，本质上是一个<code>ConcurrentHashMap&lt;String, Object&gt;</code>；并且BeanDefinition接口中包含了这个类的Class信息以及是否是单例等。那么如何从BeanDefinition中实例化Bean对象呢，这是本文主要研究的内容？@pdai</p></blockquote><ul><li><a href="#spring%E8%BF%9B%E9%98%B6--spring-ioc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E4%B9%8Bbean%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%AD%89">Spring进阶- Spring IOC实现原理详解之Bean实例化(生命周期,循环依赖等)</a><ul><li><a href="#%E5%BC%95%E5%85%A5">引入</a></li><li><a href="#beanfactory%E4%B8%ADgetbean%E7%9A%84%E4%B8%BB%E4%BD%93%E6%80%9D%E8%B7%AF">BeanFactory中getBean的主体思路</a><ul><li><a href="#%E5%88%9D%E6%AD%A5%E7%9A%84%E6%80%9D%E8%80%83">初步的思考</a></li><li><a href="#spring%E4%B8%ADgetbean%E7%9A%84%E4%B8%BB%E4%BD%93%E6%80%9D%E8%B7%AF">Spring中getBean的主体思路</a></li></ul></li><li><a href="#%E9%87%8D%E7%82%B9spring%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98">重点：Spring如何解决循环依赖问题</a><ul><li><a href="#spring%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BE%9D%E8%B5%96">Spring单例模式下的属性依赖</a></li><li><a href="#spring%E4%B8%BA%E4%BD%95%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E9%9D%9E%E5%8D%95%E4%BE%8B%E5%B1%9E%E6%80%A7%E4%B9%8B%E5%A4%96%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">Spring为何不能解决非单例属性之外的循环依赖？</a><ul><li><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">Spring为什么不能解决构造器的循环依赖？</a></li><li><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3prototype%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">Spring为什么不能解决prototype作用域循环依赖？</a></li><li><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E5%A4%9A%E4%BE%8B%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">Spring为什么不能解决多例的循环依赖？</a></li></ul></li><li><a href="#%E9%82%A3%E4%B9%88%E5%85%B6%E5%AE%83%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3">那么其它循环依赖如何解决？</a></li></ul></li><li><a href="#%E9%87%8D%E7%82%B9spring%E4%B8%ADbean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">重点：Spring中Bean的生命周期</a><ul><li><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B">Spring Bean生命周期流程</a></li><li><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A1%88%E4%BE%8B">Spring Bean生命周期案例</a></li><li><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81">Spring Bean生命周期源码</a></li></ul></li><li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">参考文章</a></li></ul></li></ul><h2 id="引入" tabindex="-1"><a class="header-anchor" href="#引入"><span><a href="#%E5%BC%95%E5%85%A5">#</a> 引入</span></a></h2><blockquote><p>上文，我们看了IOC设计要点和设计结构；以及Spring如何实现将资源配置（以xml配置为例）通过加载，解析，生成BeanDefination并注册到IoC容器中的；容器中存放的是Bean的定义即BeanDefinition放到beanDefinitionMap中，本质上是一个<code>ConcurrentHashMap&lt;String, Object&gt;</code>；并且BeanDefinition接口中包含了这个类的Class信息以及是否是单例等。那么如何从BeanDefinition中实例化Bean对象呢？</p></blockquote><p>本文主要研究如何从IOC容器已有的BeanDefinition信息，实例化出Bean对象；这里还会包括三块重点内容：</p><ul><li>BeanFactory中getBean的主体思路</li><li>Spring如何解决循环依赖问题</li><li>Spring中Bean的生命周期</li></ul><figure><img src="https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-74.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="beanfactory中getbean的主体思路" tabindex="-1"><a class="header-anchor" href="#beanfactory中getbean的主体思路"><span><a href="#beanfactory%E4%B8%ADgetbean%E7%9A%84%E4%B8%BB%E4%BD%93%E6%80%9D%E8%B7%AF">#</a> BeanFactory中getBean的主体思路</span></a></h2><blockquote><p>上文中我们知道BeanFactory定义了Bean容器的规范，其中包含根据bean的名字, Class类型和参数等来得到bean实例。</p></blockquote><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>// 根据bean的名字和Class类型等来得到bean实例    </span></span>
<span class="line"><span>Object getBean(String name) throws BeansException;    </span></span>
<span class="line"><span>Object getBean(String name, Class requiredType) throws BeansException;    </span></span>
<span class="line"><span>Object getBean(String name, Object... args) throws BeansException;</span></span>
<span class="line"><span>&lt;T&gt; T getBean(Class&lt;T&gt; requiredType) throws BeansException;</span></span>
<span class="line"><span>&lt;T&gt; T getBean(Class&lt;T&gt; requiredType, Object... args) throws BeansException;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="初步的思考" tabindex="-1"><a class="header-anchor" href="#初步的思考"><span><a href="#%E5%88%9D%E6%AD%A5%E7%9A%84%E6%80%9D%E8%80%83">#</a> 初步的思考</span></a></h3><p>上文我们已经分析了IoC初始化的流程，最终的将Bean的定义即BeanDefinition放到beanDefinitionMap中，本质上是一个<code>ConcurrentHashMap&lt;String, Object&gt;</code>；并且BeanDefinition接口中包含了这个类的Class信息以及是否是单例等；</p><figure><img src="https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-100.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这样我们初步有了实现<code>Object getBean(String name)</code>这个方法的思路：</p><ul><li>从beanDefinitionMap通过beanName获得BeanDefinition</li><li>从BeanDefinition中获得beanClassName</li><li>通过反射初始化beanClassName的实例instance <ul><li>构造函数从BeanDefinition的getConstructorArgumentValues()方法获取</li><li>属性值从BeanDefinition的getPropertyValues()方法获取</li></ul></li><li>返回beanName的实例instance</li></ul><p>由于BeanDefinition还有单例的信息，如果是无参构造函数的实例还可以放在一个缓存中，这样下次获取这个单例的实例时只需要从缓存中获取，如果获取不到再通过上述步骤获取。</p><p>（PS：如上只是我们初步的思路，而Spring还需要考虑各种设计上的问题，比如beanDefinition中其它定义，循环依赖等；所以我们来看下Spring是如何是如何实现的）</p><h3 id="spring中getbean的主体思路" tabindex="-1"><a class="header-anchor" href="#spring中getbean的主体思路"><span><a href="#spring%E4%B8%ADgetbean%E7%9A%84%E4%B8%BB%E4%BD%93%E6%80%9D%E8%B7%AF">#</a> Spring中getBean的主体思路</span></a></h3><p>BeanFactory实现getBean方法在AbstractBeanFactory中，这个方法重载都是调用doGetBean方法进行实现的：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public Object getBean(String name) throws BeansException {</span></span>
<span class="line"><span>  return doGetBean(name, null, null, false);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>public &lt;T&gt; T getBean(String name, Class&lt;T&gt; requiredType) throws BeansException {</span></span>
<span class="line"><span>  return doGetBean(name, requiredType, null, false);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>public Object getBean(String name, Object... args) throws BeansException {</span></span>
<span class="line"><span>  return doGetBean(name, null, args, false);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>public &lt;T&gt; T getBean(String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object... args)</span></span>
<span class="line"><span>    throws BeansException {</span></span>
<span class="line"><span>  return doGetBean(name, requiredType, args, false);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们来看下doGetBean方法(这个方法很长，我们主要看它的整体思路和设计要点）：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>// 参数typeCheckOnly：bean实例是否包含一个类型检查</span></span>
<span class="line"><span>protected &lt;T&gt; T doGetBean(</span></span>
<span class="line"><span>			String name, @Nullable Class&lt;T&gt; requiredType, @Nullable Object[] args, boolean typeCheckOnly)</span></span>
<span class="line"><span>			throws BeansException {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // 解析bean的真正name，如果bean是工厂类，name前缀会加&amp;，需要去掉</span></span>
<span class="line"><span>  String beanName = transformedBeanName(name);</span></span>
<span class="line"><span>  Object beanInstance;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // Eagerly check singleton cache for manually registered singletons.</span></span>
<span class="line"><span>  Object sharedInstance = getSingleton(beanName);</span></span>
<span class="line"><span>  if (sharedInstance != null &amp;&amp; args == null) {</span></span>
<span class="line"><span>    // 无参单例从缓存中获取</span></span>
<span class="line"><span>    beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, null);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  else {</span></span>
<span class="line"><span>    // 如果bean实例还在创建中，则直接抛出异常</span></span>
<span class="line"><span>    if (isPrototypeCurrentlyInCreation(beanName)) {</span></span>
<span class="line"><span>      throw new BeanCurrentlyInCreationException(beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    // 如果 bean definition 存在于父的bean工厂中，委派给父Bean工厂获取</span></span>
<span class="line"><span>    BeanFactory parentBeanFactory = getParentBeanFactory();</span></span>
<span class="line"><span>    if (parentBeanFactory != null &amp;&amp; !containsBeanDefinition(beanName)) {</span></span>
<span class="line"><span>      // Not found -&gt; check parent.</span></span>
<span class="line"><span>      String nameToLookup = originalBeanName(name);</span></span>
<span class="line"><span>      if (parentBeanFactory instanceof AbstractBeanFactory) {</span></span>
<span class="line"><span>        return ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span></span>
<span class="line"><span>            nameToLookup, requiredType, args, typeCheckOnly);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      else if (args != null) {</span></span>
<span class="line"><span>        // Delegation to parent with explicit args.</span></span>
<span class="line"><span>        return (T) parentBeanFactory.getBean(nameToLookup, args);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      else if (requiredType != null) {</span></span>
<span class="line"><span>        // No args -&gt; delegate to standard getBean method.</span></span>
<span class="line"><span>        return parentBeanFactory.getBean(nameToLookup, requiredType);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      else {</span></span>
<span class="line"><span>        return (T) parentBeanFactory.getBean(nameToLookup);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (!typeCheckOnly) {</span></span>
<span class="line"><span>      // 将当前bean实例放入alreadyCreated集合里，标识这个bean准备创建了</span></span>
<span class="line"><span>      markBeanAsCreated(beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    StartupStep beanCreation = this.applicationStartup.start(&quot;spring.beans.instantiate&quot;)</span></span>
<span class="line"><span>        .tag(&quot;beanName&quot;, name);</span></span>
<span class="line"><span>    try {</span></span>
<span class="line"><span>      if (requiredType != null) {</span></span>
<span class="line"><span>        beanCreation.tag(&quot;beanType&quot;, requiredType::toString);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</span></span>
<span class="line"><span>      checkMergedBeanDefinition(mbd, beanName, args);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      // 确保它的依赖也被初始化了.</span></span>
<span class="line"><span>      String[] dependsOn = mbd.getDependsOn();</span></span>
<span class="line"><span>      if (dependsOn != null) {</span></span>
<span class="line"><span>        for (String dep : dependsOn) {</span></span>
<span class="line"><span>          if (isDependent(beanName, dep)) {</span></span>
<span class="line"><span>            throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span></span>
<span class="line"><span>                &quot;Circular depends-on relationship between &#39;&quot; + beanName + &quot;&#39; and &#39;&quot; + dep + &quot;&#39;&quot;);</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>          registerDependentBean(dep, beanName);</span></span>
<span class="line"><span>          try {</span></span>
<span class="line"><span>            getBean(dep); // 初始化它依赖的Bean</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>          catch (NoSuchBeanDefinitionException ex) {</span></span>
<span class="line"><span>            throw new BeanCreationException(mbd.getResourceDescription(), beanName,</span></span>
<span class="line"><span>                &quot;&#39;&quot; + beanName + &quot;&#39; depends on missing bean &#39;&quot; + dep + &quot;&#39;&quot;, ex);</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      // 创建Bean实例：单例</span></span>
<span class="line"><span>      if (mbd.isSingleton()) {</span></span>
<span class="line"><span>        sharedInstance = getSingleton(beanName, () -&gt; {</span></span>
<span class="line"><span>          try {</span></span>
<span class="line"><span>            // 真正创建bean的方法</span></span>
<span class="line"><span>            return createBean(beanName, mbd, args);</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>          catch (BeansException ex) {</span></span>
<span class="line"><span>            // Explicitly remove instance from singleton cache: It might have been put there</span></span>
<span class="line"><span>            // eagerly by the creation process, to allow for circular reference resolution.</span></span>
<span class="line"><span>            // Also remove any beans that received a temporary reference to the bean.</span></span>
<span class="line"><span>            destroySingleton(beanName);</span></span>
<span class="line"><span>            throw ex;</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        });</span></span>
<span class="line"><span>        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      // 创建Bean实例：原型</span></span>
<span class="line"><span>      else if (mbd.isPrototype()) {</span></span>
<span class="line"><span>        // It&#39;s a prototype -&gt; create a new instance.</span></span>
<span class="line"><span>        Object prototypeInstance = null;</span></span>
<span class="line"><span>        try {</span></span>
<span class="line"><span>          beforePrototypeCreation(beanName);</span></span>
<span class="line"><span>          prototypeInstance = createBean(beanName, mbd, args);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        finally {</span></span>
<span class="line"><span>          afterPrototypeCreation(beanName);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>      // 创建Bean实例：根据bean的scope创建</span></span>
<span class="line"><span>      else {</span></span>
<span class="line"><span>        String scopeName = mbd.getScope();</span></span>
<span class="line"><span>        if (!StringUtils.hasLength(scopeName)) {</span></span>
<span class="line"><span>          throw new IllegalStateException(&quot;No scope name defined for bean ´&quot; + beanName + &quot;&#39;&quot;);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        Scope scope = this.scopes.get(scopeName);</span></span>
<span class="line"><span>        if (scope == null) {</span></span>
<span class="line"><span>          throw new IllegalStateException(&quot;No Scope registered for scope name &#39;&quot; + scopeName + &quot;&#39;&quot;);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        try {</span></span>
<span class="line"><span>          Object scopedInstance = scope.get(beanName, () -&gt; {</span></span>
<span class="line"><span>            beforePrototypeCreation(beanName);</span></span>
<span class="line"><span>            try {</span></span>
<span class="line"><span>              return createBean(beanName, mbd, args);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            finally {</span></span>
<span class="line"><span>              afterPrototypeCreation(beanName);</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>          });</span></span>
<span class="line"><span>          beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        catch (IllegalStateException ex) {</span></span>
<span class="line"><span>          throw new ScopeNotActiveException(beanName, scopeName, ex);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>      }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    catch (BeansException ex) {</span></span>
<span class="line"><span>      beanCreation.tag(&quot;exception&quot;, ex.getClass().toString());</span></span>
<span class="line"><span>      beanCreation.tag(&quot;message&quot;, String.valueOf(ex.getMessage()));</span></span>
<span class="line"><span>      cleanupAfterBeanCreationFailure(beanName);</span></span>
<span class="line"><span>      throw ex;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    finally {</span></span>
<span class="line"><span>      beanCreation.end();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  return adaptBeanInstance(name, beanInstance, requiredType);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码很长，主要看我加中文注释的方法即可。</p><ul><li>解析bean的真正name，如果bean是工厂类，name前缀会加&amp;，需要去掉</li><li>无参单例先从缓存中尝试获取</li><li>如果bean实例还在创建中，则直接抛出异常</li><li>如果bean definition 存在于父的bean工厂中，委派给父Bean工厂获取</li><li>标记这个beanName的实例正在创建</li><li>确保它的依赖也被初始化</li><li>真正创建 <ul><li>单例时</li><li>原型时</li><li>根据bean的scope创建</li></ul></li></ul><h2 id="重点-spring如何解决循环依赖问题" tabindex="-1"><a class="header-anchor" href="#重点-spring如何解决循环依赖问题"><span><a href="#%E9%87%8D%E7%82%B9-spring%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98">#</a> 重点：Spring如何解决循环依赖问题</span></a></h2><blockquote><p>首先我们需要说明，Spring只是解决了单例模式下属性依赖的循环问题；Spring为了解决单例的循环依赖问题，使用了三级缓存。</p></blockquote><h3 id="spring单例模式下的属性依赖" tabindex="-1"><a class="header-anchor" href="#spring单例模式下的属性依赖"><span><a href="#spring%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%B1%9E%E6%80%A7%E4%BE%9D%E8%B5%96">#</a> Spring单例模式下的属性依赖</span></a></h3><p>先来看下这三级缓存</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/** Cache of singleton objects: bean name --&gt; bean instance */</span></span>
<span class="line"><span>private final Map&lt;String, Object&gt; singletonObjects = new ConcurrentHashMap&lt;String, Object&gt;(256);</span></span>
<span class="line"><span> </span></span>
<span class="line"><span>/** Cache of early singleton objects: bean name --&gt; bean instance */</span></span>
<span class="line"><span>private final Map&lt;String, Object&gt; earlySingletonObjects = new HashMap&lt;String, Object&gt;(16);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/** Cache of singleton factories: bean name --&gt; ObjectFactory */</span></span>
<span class="line"><span>private final Map&lt;String, ObjectFactory&lt;?&gt;&gt; singletonFactories = new HashMap&lt;String, ObjectFactory&lt;?&gt;&gt;(16);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>第一层缓存（singletonObjects）</strong>：单例对象缓存池，已经实例化并且属性赋值，这里的对象是<strong>成熟对象</strong>；</li><li><strong>第二层缓存（earlySingletonObjects）</strong>：单例对象缓存池，已经实例化但尚未属性赋值，这里的对象是<strong>半成品对象</strong>；</li><li><strong>第三层缓存（singletonFactories）</strong>: 单例工厂的缓存</li></ul><p>如下是获取单例中</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>protected Object getSingleton(String beanName, boolean allowEarlyReference) {</span></span>
<span class="line"><span>  // Spring首先从singletonObjects（一级缓存）中尝试获取</span></span>
<span class="line"><span>  Object singletonObject = this.singletonObjects.get(beanName);</span></span>
<span class="line"><span>  // 若是获取不到而且对象在建立中，则尝试从earlySingletonObjects(二级缓存)中获取</span></span>
<span class="line"><span>  if (singletonObject == null &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {</span></span>
<span class="line"><span>    synchronized (this.singletonObjects) {</span></span>
<span class="line"><span>        singletonObject = this.earlySingletonObjects.get(beanName);</span></span>
<span class="line"><span>        if (singletonObject == null &amp;&amp; allowEarlyReference) {</span></span>
<span class="line"><span>          ObjectFactory&lt;?&gt; singletonFactory = this.singletonFactories.get(beanName);</span></span>
<span class="line"><span>          if (singletonFactory != null) {</span></span>
<span class="line"><span>            //若是仍是获取不到而且容许从singletonFactories经过getObject获取，则经过singletonFactory.getObject()(三级缓存)获取</span></span>
<span class="line"><span>              singletonObject = singletonFactory.getObject();</span></span>
<span class="line"><span>              //若是获取到了则将singletonObject放入到earlySingletonObjects,也就是将三级缓存提高到二级缓存中</span></span>
<span class="line"><span>              this.earlySingletonObjects.put(beanName, singletonObject);</span></span>
<span class="line"><span>              this.singletonFactories.remove(beanName);</span></span>
<span class="line"><span>          }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>  return (singletonObject != NULL_OBJECT ? singletonObject : null);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>补充一些方法和参数</p><ul><li><code>isSingletonCurrentlyInCreation()</code>：判断当前单例bean是否正在建立中，也就是没有初始化完成(好比A的构造器依赖了B对象因此得先去建立B对象， 或则在A的populateBean过程当中依赖了B对象，得先去建立B对象，这时的A就是处于建立中的状态。)</li><li><code>allowEarlyReference</code> ：是否容许从singletonFactories中经过getObject拿到对象</li></ul><p>分析getSingleton()的整个过程，Spring首先从一级缓存singletonObjects中获取。若是获取不到，而且对象正在建立中，就再从二级缓存earlySingletonObjects中获取。若是仍是获取不到且容许singletonFactories经过getObject()获取，就从三级缓存singletonFactory.getObject()(三级缓存)获取，若是获取到了则从三级缓存移动到了二级缓存。</p><p>从上面三级缓存的分析，咱们能够知道，Spring解决循环依赖的诀窍就在于singletonFactories这个三级cache。这个cache的类型是ObjectFactory，定义以下：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public interface ObjectFactory&lt;T&gt; {</span></span>
<span class="line"><span>    T getObject() throws BeansException;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在bean建立过程当中，有两处比较重要的匿名内部类实现了该接口。一处是Spring利用其建立bean的时候，另外一处就是:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>addSingletonFactory(beanName, new ObjectFactory&lt;Object&gt;() {</span></span>
<span class="line"><span>   @Override   public Object getObject() throws BeansException {</span></span>
<span class="line"><span>      return getEarlyBeanReference(beanName, mbd, bean);</span></span>
<span class="line"><span>   }});</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此处就是解决循环依赖的关键，这段代码发生在createBeanInstance以后，也就是说单例对象此时已经被建立出来的。这个对象已经被生产出来了，虽然还不完美（尚未进行初始化的第二步和第三步），可是已经能被人认出来了（根据对象引用能定位到堆中的对象），因此Spring此时将这个对象提早曝光出来让你们认识，让你们使用。</p><p>好比“A对象setter依赖B对象，B对象setter依赖A对象”，A首先完成了初始化的第一步，而且将本身提早曝光到singletonFactories中，此时进行初始化的第二步，发现本身依赖对象B，此时就尝试去get(B)，发现B尚未被create，因此走create流程，B在初始化第一步的时候发现本身依赖了对象A，因而尝试get(A)，尝试一级缓存singletonObjects(确定没有，由于A还没初始化彻底)，尝试二级缓存earlySingletonObjects（也没有），尝试三级缓存singletonFactories，因为A经过ObjectFactory将本身提早曝光了，因此B可以经过ObjectFactory.getObject拿到A对象(半成品)，B拿到A对象后顺利完成了初始化阶段一、二、三，彻底初始化以后将本身放入到一级缓存singletonObjects中。此时返回A中，A此时能拿到B的对象顺利完成本身的初始化阶段二、三，最终A也完成了初始化，进去了一级缓存singletonObjects中，并且更加幸运的是，因为B拿到了A的对象引用，因此B如今hold住的A对象完成了初始化。</p><h3 id="spring为何不能解决非单例属性之外的循环依赖" tabindex="-1"><a class="header-anchor" href="#spring为何不能解决非单例属性之外的循环依赖"><span><a href="#spring%E4%B8%BA%E4%BD%95%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E9%9D%9E%E5%8D%95%E4%BE%8B%E5%B1%9E%E6%80%A7%E4%B9%8B%E5%A4%96%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">#</a> Spring为何不能解决非单例属性之外的循环依赖？</span></a></h3><blockquote><p>通过以下几个问题，辅助我们进一步理解。</p></blockquote><h4 id="spring为什么不能解决构造器的循环依赖" tabindex="-1"><a class="header-anchor" href="#spring为什么不能解决构造器的循环依赖"><span><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">#</a> Spring为什么不能解决构造器的循环依赖？</span></a></h4><p>构造器注入形成的循环依赖： 也就是beanB需要在beanA的构造函数中完成初始化，beanA也需要在beanB的构造函数中完成初始化，这种情况的结果就是两个bean都不能完成初始化，循环依赖难以解决。</p><p>Spring解决循环依赖主要是依赖三级缓存，但是的<strong>在调用构造方法之前还未将其放入三级缓存之中</strong>，因此后续的依赖调用构造方法的时候并不能从三级缓存中获取到依赖的Bean，因此不能解决。</p><h4 id="spring为什么不能解决prototype作用域循环依赖" tabindex="-1"><a class="header-anchor" href="#spring为什么不能解决prototype作用域循环依赖"><span><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3prototype%E4%BD%9C%E7%94%A8%E5%9F%9F%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">#</a> Spring为什么不能解决prototype作用域循环依赖？</span></a></h4><p>这种循环依赖同样无法解决，因为spring不会缓存‘prototype’作用域的bean，而spring中循环依赖的解决正是通过缓存来实现的。</p><h4 id="spring为什么不能解决多例的循环依赖" tabindex="-1"><a class="header-anchor" href="#spring为什么不能解决多例的循环依赖"><span><a href="#spring%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E8%A7%A3%E5%86%B3%E5%A4%9A%E4%BE%8B%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96">#</a> Spring为什么不能解决多例的循环依赖？</span></a></h4><p>多实例Bean是每次调用一次getBean都会执行一次构造方法并且给属性赋值，根本没有三级缓存，因此不能解决循环依赖。</p><h3 id="那么其它循环依赖如何解决" tabindex="-1"><a class="header-anchor" href="#那么其它循环依赖如何解决"><span><a href="#%E9%82%A3%E4%B9%88%E5%85%B6%E5%AE%83%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3">#</a> 那么其它循环依赖如何解决？</span></a></h3><blockquote><p>那么实际开发中，类似的依赖是如何解决？</p></blockquote><ul><li><strong>生成代理对象产生的循环依赖</strong></li></ul><p>这类循环依赖问题解决方法很多，主要有：</p><ol><li>使用@Lazy注解，延迟加载</li><li>使用@DependsOn注解，指定加载先后关系</li><li>修改文件名称，改变循环依赖类的加载顺序</li></ol><ul><li><strong>使用@DependsOn产生的循环依赖</strong></li></ul><p>这类循环依赖问题要找到@DependsOn注解循环依赖的地方，迫使它不循环依赖就可以解决问题。</p><ul><li><strong>多例循环依赖</strong></li></ul><p>这类循环依赖问题可以通过把bean改成单例的解决。</p><ul><li><strong>构造器循环依赖</strong></li></ul><p>这类循环依赖问题可以通过使用@Lazy注解解决。</p><h2 id="重点-spring中bean的生命周期" tabindex="-1"><a class="header-anchor" href="#重点-spring中bean的生命周期"><span><a href="#%E9%87%8D%E7%82%B9-spring%E4%B8%ADbean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">#</a> 重点：Spring中Bean的生命周期</span></a></h2><blockquote><p>Spring 只帮我们管理单例模式 Bean 的<strong>完整</strong>生命周期，对于 prototype 的 bean ，Spring 在创建好交给使用者之后则不会再管理后续的生命周期。</p></blockquote><p>Spring 容器可以管理 singleton 作用域 Bean 的生命周期，在此作用域下，Spring 能够精确地知道该 Bean 何时被创建，何时初始化完成，以及何时被销毁。</p><p>而对于 prototype 作用域的 Bean，Spring 只负责创建，当容器创建了 Bean 的实例后，Bean 的实例就交给客户端代码管理，Spring 容器将不再跟踪其生命周期。每次客户端请求 prototype 作用域的 Bean 时，Spring 容器都会创建一个新的实例，并且不会管那些被配置成 prototype 作用域的 Bean 的生命周期。</p><p>了解 Spring 生命周期的意义就在于，<strong>可以利用 Bean 在其存活期间的指定时刻完成一些相关操作</strong>。这种时刻可能有很多，但一般情况下，会在 Bean 被初始化后和被销毁前执行一些相关操作。</p><h3 id="spring-bean生命周期流程" tabindex="-1"><a class="header-anchor" href="#spring-bean生命周期流程"><span><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B">#</a> Spring Bean生命周期流程</span></a></h3><blockquote><p>在 Spring 中，Bean 的生命周期是一个很复杂的执行过程，我们可以利用 Spring 提供的方法定制 Bean 的创建过程。</p></blockquote><p><strong>Spring 容器中 Bean 的生命周期流程</strong></p><figure><img src="https://pdai.tech/images/spring/springframework/spring-framework-ioc-source-102.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>如果 BeanFactoryPostProcessor 和 Bean 关联, 则调用postProcessBeanFactory方法.(即首<strong>先尝试从Bean工厂中获取Bean</strong>)</li><li>如果 InstantiationAwareBeanPostProcessor 和 Bean 关联，则调用postProcessBeforeInstantiation方法</li><li>根据配置情况调用 Bean 构造方法<strong>实例化 Bean</strong>。</li><li>利用依赖注入完成 Bean 中所有<strong>属性值的配置注入</strong>。</li><li>如果 InstantiationAwareBeanPostProcessor 和 Bean 关联，则调用postProcessAfterInstantiation方法和postProcessProperties</li><li><strong>调用xxxAware接口</strong> (上图只是给了几个例子) <ul><li><strong>第一类Aware接口</strong><ul><li>如果 Bean 实现了 BeanNameAware 接口，则 Spring 调用 Bean 的 setBeanName() 方法传入当前 Bean 的 id 值。</li><li>如果 Bean 实现了 BeanClassLoaderAware 接口，则 Spring 调用 setBeanClassLoader() 方法传入classLoader的引用。</li><li>如果 Bean 实现了 BeanFactoryAware 接口，则 Spring 调用 setBeanFactory() 方法传入当前工厂实例的引用。</li></ul></li><li><strong>第二类Aware接口</strong><ul><li>如果 Bean 实现了 EnvironmentAware 接口，则 Spring 调用 setEnvironment() 方法传入当前 Environment 实例的引用。</li><li>如果 Bean 实现了 EmbeddedValueResolverAware 接口，则 Spring 调用 setEmbeddedValueResolver() 方法传入当前 StringValueResolver 实例的引用。</li><li>如果 Bean 实现了 ApplicationContextAware 接口，则 Spring 调用 setApplicationContext() 方法传入当前 ApplicationContext 实例的引用。</li><li>...</li></ul></li></ul></li><li>如果 BeanPostProcessor 和 Bean 关联，则 Spring 将调用该接口的预初始化方法 postProcessBeforeInitialzation() 对 Bean 进行加工操作，此处非常重要，Spring 的 AOP 就是利用它实现的。</li><li>如果 Bean 实现了 InitializingBean 接口，则 Spring 将调用 afterPropertiesSet() 方法。(或者有执行@PostConstruct注解的方法)</li><li>如果在配置文件中通过 <strong>init-method</strong> 属性指定了初始化方法，则调用该初始化方法。</li><li>如果 BeanPostProcessor 和 Bean 关联，则 Spring 将调用该接口的初始化方法 postProcessAfterInitialization()。此时，Bean 已经可以被应用系统使用了。</li><li>如果在 <code>&lt;bean&gt;</code> 中指定了该 Bean 的作用范围为 scope=&quot;singleton&quot;，则将该 Bean 放入 Spring IoC 的缓存池中，将触发 Spring 对该 Bean 的生命周期管理；如果在 <code>&lt;bean&gt;</code> 中指定了该 Bean 的作用范围为 scope=&quot;prototype&quot;，则将该 Bean 交给调用者，调用者管理该 Bean 的生命周期，Spring 不再管理该 Bean。</li><li>如果 Bean 实现了 DisposableBean 接口，则 Spring 会调用 destory() 方法将 Spring 中的 Bean 销毁；(或者有执行@PreDestroy注解的方法)</li><li>如果在配置文件中通过 <strong>destory-method</strong> 属性指定了 Bean 的销毁方法，则 Spring 将调用该方法对 Bean 进行销毁。</li></ul><p><strong>Bean的完整生命周期经历了各种方法调用，这些方法可以划分为以下几类</strong>：(结合上图，需要有如下顶层思维)</p><ul><li><strong>Bean自身的方法</strong>： 这个包括了Bean本身调用的方法和通过配置文件中<code>&lt;bean&gt;</code>的init-method和destroy-method指定的方法</li><li><strong>Bean级生命周期接口方法</strong>： 这个包括了BeanNameAware、BeanFactoryAware、ApplicationContextAware；当然也包括InitializingBean和DiposableBean这些接口的方法（可以被@PostConstruct和@PreDestroy注解替代)</li><li><strong>容器级生命周期接口方法</strong>： 这个包括了InstantiationAwareBeanPostProcessor 和 BeanPostProcessor 这两个接口实现，一般称它们的实现类为“后处理器”。</li><li><strong>工厂后处理器接口方法</strong>： 这个包括了AspectJWeavingEnabler, ConfigurationClassPostProcessor, CustomAutowireConfigurer等等非常有用的工厂后处理器接口的方法。工厂后处理器也是容器级的。在应用上下文装配配置文件之后立即调用。</li></ul><h3 id="spring-bean生命周期案例" tabindex="-1"><a class="header-anchor" href="#spring-bean生命周期案例"><span><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%A1%88%E4%BE%8B">#</a> Spring Bean生命周期案例</span></a></h3><blockquote><p>我们通过一个例子来验证上面的整个流程</p></blockquote><p>定义Bean（这里是User）, 并让它实现BeanNameAware,BeanFactoryAware,ApplicationContextAware接口和InitializingBean,DisposableBean接口：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>package tech.pdai.springframework.entity;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import lombok.ToString;</span></span>
<span class="line"><span>import lombok.extern.slf4j.Slf4j;</span></span>
<span class="line"><span>import org.springframework.beans.BeansException;</span></span>
<span class="line"><span>import org.springframework.beans.factory.BeanFactory;</span></span>
<span class="line"><span>import org.springframework.beans.factory.BeanFactoryAware;</span></span>
<span class="line"><span>import org.springframework.beans.factory.BeanNameAware;</span></span>
<span class="line"><span>import org.springframework.beans.factory.DisposableBean;</span></span>
<span class="line"><span>import org.springframework.beans.factory.InitializingBean;</span></span>
<span class="line"><span>import org.springframework.context.ApplicationContext;</span></span>
<span class="line"><span>import org.springframework.context.ApplicationContextAware;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@ToString</span></span>
<span class="line"><span>public class User implements BeanFactoryAware, BeanNameAware, ApplicationContextAware,</span></span>
<span class="line"><span>        InitializingBean, DisposableBean {</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * user&#39;s name.</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private String name;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * user&#39;s age.</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private int age;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * bean factory.</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private BeanFactory beanFactory;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * application context.</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private ApplicationContext applicationContext;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * bean name.</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    private String beanName;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public User() {</span></span>
<span class="line"><span>        log.info(&quot;execute User#new User()&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public void setName(String name) {</span></span>
<span class="line"><span>        log.info(&quot;execute User#setName({})&quot;, name);</span></span>
<span class="line"><span>        this.name = name;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public void setAge(int age) {</span></span>
<span class="line"><span>        log.info(&quot;execute User#setAge({})&quot;, age);</span></span>
<span class="line"><span>        this.age = age;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void setBeanFactory(BeanFactory beanFactory) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute BeanFactoryAware#setBeanFactory&quot;);</span></span>
<span class="line"><span>        this.beanFactory = beanFactory;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void setBeanName(String s) {</span></span>
<span class="line"><span>        log.info(&quot;execute BeanNameAware#setBeanName&quot;);</span></span>
<span class="line"><span>        this.beanName = s;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute ApplicationContextAware#setApplicationContext&quot;);</span></span>
<span class="line"><span>        this.applicationContext = applicationContext;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void destroy() throws Exception {</span></span>
<span class="line"><span>        log.info(&quot;execute DisposableBean#destroy&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void afterPropertiesSet() throws Exception {</span></span>
<span class="line"><span>        log.info(&quot;execute InitializingBean#afterPropertiesSet&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public void doInit() {</span></span>
<span class="line"><span>        log.info(&quot;execute User#doInit&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public void doDestroy() {</span></span>
<span class="line"><span>        log.info(&quot;execute User#doDestroy&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义BeanFactoryPostProcessor的实现类</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/**</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class MyBeanFactoryPostProcessor implements BeanFactoryPostProcessor {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void postProcessBeanFactory(ConfigurableListableBeanFactory configurableListableBeanFactory) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute BeanFactoryPostProcessor#postProcessBeanFactory&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义InstantiationAwareBeanPostProcessor的实现类</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/**</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class MyInstantiationAwareBeanPostProcessor implements InstantiationAwareBeanPostProcessor {</span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public Object postProcessBeforeInstantiation(Class&lt;?&gt; beanClass, String beanName) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation for {}&quot;, beanName);</span></span>
<span class="line"><span>        return InstantiationAwareBeanPostProcessor.super.postProcessBeforeInstantiation(beanClass, beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation for {}&quot;, beanName);</span></span>
<span class="line"><span>        return InstantiationAwareBeanPostProcessor.super.postProcessAfterInstantiation(bean, beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute InstantiationAwareBeanPostProcessor#postProcessProperties for {}&quot;, beanName);</span></span>
<span class="line"><span>        return InstantiationAwareBeanPostProcessor.super.postProcessProperties(pvs, bean, beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义BeanPostProcessor的实现类</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/**</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class MyBeanPostProcessor implements BeanPostProcessor {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute BeanPostProcessor#postProcessBeforeInitialization for {}&quot;, beanName);</span></span>
<span class="line"><span>        return BeanPostProcessor.super.postProcessBeforeInitialization(bean, beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {</span></span>
<span class="line"><span>        log.info(&quot;execute BeanPostProcessor#postProcessAfterInitialization for {}&quot;, beanName);</span></span>
<span class="line"><span>        return BeanPostProcessor.super.postProcessAfterInitialization(bean, beanName);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过Java配置方式初始化Bean</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/**</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Configuration</span></span>
<span class="line"><span>public class BeansConfig {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Bean(name = &quot;user&quot;, initMethod = &quot;doInit&quot;, destroyMethod = &quot;doDestroy&quot;)</span></span>
<span class="line"><span>    public User create() {</span></span>
<span class="line"><span>        User user = new User();</span></span>
<span class="line"><span>        user.setName(&quot;pdai&quot;);</span></span>
<span class="line"><span>        user.setAge(18);</span></span>
<span class="line"><span>        return user;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试的主方法</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>/**</span></span>
<span class="line"><span> * Cglib proxy demo.</span></span>
<span class="line"><span> *</span></span>
<span class="line"><span> * @author pdai</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>public class App {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * main interface.</span></span>
<span class="line"><span>     *</span></span>
<span class="line"><span>     * @param args args</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        log.info(&quot;Init application context&quot;);</span></span>
<span class="line"><span>        // create and configure beans</span></span>
<span class="line"><span>        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(</span></span>
<span class="line"><span>                &quot;tech.pdai.springframework&quot;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // retrieve configured instance</span></span>
<span class="line"><span>        User user = (User) context.getBean(&quot;user&quot;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        // print info from beans</span></span>
<span class="line"><span>        log.info(user.toString());</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        log.info(&quot;Shutdown application context&quot;);</span></span>
<span class="line"><span>        context.registerShutdownHook();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果（剔除无关输出）：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>12:44:42.547 [main] INFO tech.pdai.springframework.App - Init application context</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>12:44:43.134 [main] INFO tech.pdai.springframework.processor.MyBeanFactoryPostProcessor - execute BeanFactoryPostProcessor#postProcessBeanFactory</span></span>
<span class="line"><span>...</span></span>
<span class="line"><span>12:44:43.216 [main] DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean &#39;user&#39;</span></span>
<span class="line"><span>12:44:43.216 [main] INFO tech.pdai.springframework.processor.MyInstantiationAwareBeanPostProcessor - execute InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation for user</span></span>
<span class="line"><span>12:44:43.236 [main] INFO tech.pdai.springframework.entity.User - execute User#new User()</span></span>
<span class="line"><span>12:44:43.237 [main] INFO tech.pdai.springframework.entity.User - execute User#setName(pdai)</span></span>
<span class="line"><span>12:44:43.237 [main] INFO tech.pdai.springframework.entity.User - execute User#setAge(18)</span></span>
<span class="line"><span>12:44:43.237 [main] INFO tech.pdai.springframework.processor.MyInstantiationAwareBeanPostProcessor - execute InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation for user</span></span>
<span class="line"><span>12:44:43.237 [main] INFO tech.pdai.springframework.processor.MyInstantiationAwareBeanPostProcessor - execute InstantiationAwareBeanPostProcessor#postProcessProperties for user</span></span>
<span class="line"><span>12:44:43.242 [main] INFO tech.pdai.springframework.entity.User - execute BeanNameAware#setBeanName</span></span>
<span class="line"><span>12:44:43.242 [main] INFO tech.pdai.springframework.entity.User - execute BeanFactoryAware#setBeanFactory</span></span>
<span class="line"><span>12:44:43.242 [main] INFO tech.pdai.springframework.entity.User - execute ApplicationContextAware#setApplicationContext</span></span>
<span class="line"><span>12:44:43.242 [main] INFO tech.pdai.springframework.processor.MyBeanPostProcessor - execute BeanPostProcessor#postProcessBeforeInitialization for user</span></span>
<span class="line"><span>12:44:43.242 [main] INFO tech.pdai.springframework.entity.User - execute InitializingBean#afterPropertiesSet</span></span>
<span class="line"><span>12:44:43.243 [main] INFO tech.pdai.springframework.entity.User - execute User#doInit</span></span>
<span class="line"><span>12:44:43.243 [main] INFO tech.pdai.springframework.processor.MyBeanPostProcessor - execute BeanPostProcessor#postProcessAfterInitialization for user</span></span>
<span class="line"><span>12:44:43.270 [main] INFO tech.pdai.springframework.App - User(name=pdai, age=18)</span></span>
<span class="line"><span>12:44:43.270 [main] INFO tech.pdai.springframework.App - Shutdown application context</span></span>
<span class="line"><span>12:44:43.276 [SpringContextShutdownHook] INFO tech.pdai.springframework.entity.User - execute DisposableBean#destroy</span></span>
<span class="line"><span>12:44:43.276 [SpringContextShutdownHook] INFO tech.pdai.springframework.entity.User - execute User#doDestroy</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="spring-bean生命周期源码" tabindex="-1"><a class="header-anchor" href="#spring-bean生命周期源码"><span><a href="#spring-bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%BA%90%E7%A0%81">#</a> Spring Bean生命周期源码</span></a></h3><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章"><span><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">#</a> 参考文章</span></a></h2><p>https://juejin.cn/post/6844903843596107790</p><p>https://www.zhihu.com/question/438247718/answer/1730527725</p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">上次编辑于: </span><!----></div><!----></div></footer><!----><div id="vp-comment" class="giscus-wrapper input-top" style="display:block;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><!----><div class="vp-copyright">
  版权声明：自由转载 - 非商用 - 非衍生 - 保持署名<a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh-hans" target="_blank" rel="noopener noreferrer">（创意共享 4.0 许可证）</a>|
  Copyright © 2024-present </a>
  </div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script src="/assets/js/runtime~app.b1768b64.js" defer></script><script src="/assets/js/5755.cf3ac905.js" defer></script><script src="/assets/js/app.a0e07665.js" defer></script>
    <!-- 看板娘区块 -->
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End 看板娘区块 -->
  </body>
</html>

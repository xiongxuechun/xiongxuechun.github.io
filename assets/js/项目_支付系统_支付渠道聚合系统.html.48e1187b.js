"use strict";(self.webpackChunklearn_data=self.webpackChunklearn_data||[]).push([[64],{9168:(i,s)=>{s.A=(i,s)=>{const a=i.__vccOpts||i;for(const[i,t]of s)a[i]=t;return a}},2053:(i,s,a)=>{a.r(s),a.d(s,{comp:()=>A,data:()=>D});var t=a(6904);const h=a.p+"assets/img/支付系统业务架构.0a52e6c5.png",n=a.p+"assets/img/支付系统流程1.7b43dc35.png",l=a.p+"assets/img/course-payment流程.07dcbb79.png",k=a.p+"assets/img/支付系统架构设计.109269ce.png",p=a.p+"assets/img/支付模块设计.e1f3f00f.jpg",e=a.p+"assets/img/支付回调设计.86c73283.jpg",d=a.p+"assets/img/退款模块设计.a9d57705.jpg",r=a.p+"assets/img/退款状态机设计.2eb560bc.jpg",g=a.p+"assets/img/系统异常处理设计.aa6b9125.jpg",B=[(0,t.Fv)('<h1 id="支付系统设计-服务端" tabindex="-1"><a class="header-anchor" href="#支付系统设计-服务端"><span>支付系统设计--服务端</span></a></h1><h1 id="一-背景" tabindex="-1"><a class="header-anchor" href="#一-背景"><span>一. 背景</span></a></h1><p>​ 随着业务的快速发展与变化，业务模式由原有的独立 APP 售卖模式调整为以业务为导向，各业务百花齐放，各自建设业务系统模式。原有售卖模式采用的支付方式与独立 APP 耦合，且支付方式仅支持一个AppId，对应一个微信或支付宝商户号，无法满足各业务搭建 App 及独立售卖的模式。需要提供业务统一的支付平台能力，支持业务与支付中心一次对接，即可打通支付整体流程。</p><p>支付中心在现代企业中扮演着至关重要的角色，它不仅是内部业务线之间的支付服务提供者，还是与外部三方支付机构或银行之间的资金流转的桥梁，有助于实现支付流程的标准化、高效化和安全化。</p><ul><li>对内方面：支付中心为各业务线提供统一的支付和退款服务，方便各业务之间的数据交互和整合，有助于简化业务流程，减少重复开发和维护成本，同时提高支付和退款的处理效率；</li><li>对外方面：支付中心需要对接各种三方支付机构或银行服务，实现资金的流转，为企业提供更广泛、更灵活的支付结算服务，满足企业不断增长的业务需求。</li></ul><p>支付中心系统的设计旨在实现对内统一支付和退款服务，对外对接三方支付服务，实现资金流转。</p><h2 id="_1-业务架构" tabindex="-1"><a class="header-anchor" href="#_1-业务架构"><span>1. 业务架构</span></a></h2><p>支付中心是一个支付聚合服务，旨在最大程度减少其他服务对接第三方支付的开发量，并将支付相关功能、信息统一化管理。</p><figure><img src="'+h+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_2-极简支付流程" tabindex="-1"><a class="header-anchor" href="#_2-极简支付流程"><span>2. 极简支付流程</span></a></h2><p>从服务端设计的角度看，一个极简的订单支付的流程如下：</p><img src="'+n+'" style="zoom:80%;"><ol><li>创建订单：用户从客户端下单，创建订单的流程，生成订单记录（通常包括订单号、用户信息、商品详情、总价、支付状态等）；</li><li>生成支付信息：商家服务端会根据订单信息生成支付信息，包括支付金额、支付方式、订单号等，用于后续的支付流程；</li><li>返回支付页面：服务端将支付信息返回给客户端，客户端根据支付信息生成支付页面(包含支付金额、支付方式、订单号等信息)，并引导用户进行支付操作；</li><li>发起支付：用户在支付下单页，点击支付，服务端会组装支付参数请求第三方支付进行下单；</li><li>支付结果通知：用户支付完成后，三方支付平台(如支付宝、微信支付等)会向服务端发送支付结果通知。服务端接收到支付结果通知后，会对支付结果进行处理：如果支付成功，服务端会更新订单状态为已支付，并进行相应的业务处理(如库存扣减、通知卖家发货等)；如果支付失败，服务端会更新订单状态为支付失败，并通知用户重新进行支付。</li><li>支付结果回调：服务端将支付结果返回给客户端并展示给用户。如果支付成功，客户端会展示支付成功页面，并引导用户进行后续操作(如查看订单详情等)，如果支付失败，客户端会展示支付失败页面，并提示用户重新进行支付。</li></ol><p>整体支付流程的时序图可如下所示：</p><figure><img src="'+l+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h1 id="二-支付中心系统设计" tabindex="-1"><a class="header-anchor" href="#二-支付中心系统设计"><span>二. 支付中心系统设计</span></a></h1><h2 id="_1-系统架构设计" tabindex="-1"><a class="header-anchor" href="#_1-系统架构设计"><span>1. 系统架构设计</span></a></h2><p>支付中心系统的主要职责是处理业务系统发起的所有交易请求，包含商户系统、支付核心等模块，如图所示，主要分为四个大模块：</p><ol><li><p>应用平台：对外提供API网关接口，供其他业务订单系统调用；</p></li><li><p>业务中台：主要包括商户系统和支付系统；</p><ul><li><p>商户系统：主要关注的是与商户相关的所有业务和功能，包括但不限于商户配置、支付配置、通知配置、交易对账等。商户系统通过提供统一、高效、安全的服务接口，帮助商户更好地管理自己的业务，提高运营效率，降低运营成本；</p></li><li><p>支付系统：主要负责与外部支付通道统一打通，包括但不限于交易支付、退款、回调通知、订单补偿、差错处理、异常通知，包括对业务中台各项服务的配置、监控等；</p></li><li><p>支付通道：用于和三方支付进行对接及管理；</p></li></ul></li><li><p>技术架构：用于实现整个系统功能的技术架构；</p></li></ol><figure><img src="'+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="_2-详细设计" tabindex="-1"><a class="header-anchor" href="#_2-详细设计"><span>2. 详细设计</span></a></h2><h3 id="_2-1-支付模块设计" tabindex="-1"><a class="header-anchor" href="#_2-1-支付模块设计"><span>2.1. 支付模块设计</span></a></h3><p>业务商户系统在支付时通过统一接口请求支付，对第三方支付平台无感知，由支付系统做统一处理。在进行对接之前，业务商户系统需要在支付系统填写商户信息以便后续支付，整体执行顺序和模块主要包含三部分：</p><ol><li><strong>生成预支付订单</strong>：业务系统调用支付中心之后，支付中心校验商户信息、权限校验，生成支付中心全局唯一支付单号，生成支付订单记录；</li><li><strong>三方支付交互</strong>：支付中心根据支付类型和交易类型以及对应的三方支付接口，生成接口交互签名，组装成统一的支付请求与三方支付交互；</li><li><strong>支付后置处理</strong>：支付中心根据当前支付请求和三方接口响应，落库记录支付订单信息；</li></ol><figure><img src="'+p+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p><strong>生成预支付订单的主要步骤</strong></p><p>​ a. 校验商户信息：支付中心从数据库中获取商户信息，并校验商户号、商户状态和交易类型等信息；</p><p>​ b. 权限校验：校验商户是否有权限进行当前支付操作，确保商户有权限进行当前支付操作；</p><p>​ c. 生成支付中心订单号；</p><p>​ d. 创建支付订单对象：根据支付请求信息和商户信息，创建支付订单对象。</p></li></ul><p>支付中心唯一支付订单号的生成方法如下：</p><ol><li><p>获取当前时间戳：以秒为单位获取当前时间戳。</p></li><li><p>生成 Redis 键：</p><ul><li><p>使用 <code>pay:order_id:</code> 作为前缀，加上当前时间戳，生成 Redis 键。</p></li><li><p>使用 Redis 中 <code>setIfAbsent</code> 设置键值对，如果键不存在则设置成功，并设置过期时间为 10 秒。</p></li><li><p>如果 Redis 中已经有该键，使用 <code>increment</code> 方法对键值进行自增，并将结果转换为字符串。</p></li><li><p>如果 Redis 操作失败，使用备用方案生成 6 位随机数作为订单号计数部分。</p></li></ul></li><li><p>格式化订单号：将订单号序列格式化为 6 位数字，不足位数前面补零。</p></li><li><p>拼接订单号：将支付类型编号、当前时间戳、订单号计数和 4 位随机数拼接在一起，生成最终的支付单号；</p></li></ol><ul><li><p>例如：订单号：4 1732690422 000001 7403 ，其中 4 是指支付宝支付；1732690422 是时间戳；000001 为订单号计数器；7403 是四位随机数。</p></li><li><p><strong>三方支付交互</strong></p></li></ul><p>支付中心根据支付类型和交易类型，选择对应的三方支付接口，生成接口交互签名，组装成统一的支付请求与三方支付交互，三方支付交互的主要步骤如下：</p><ol><li>根据支付类型和交易类型，选择对应的三方支付接口；</li><li>使用三方支付接口所需的参数和加密方法，生成签名；</li><li>将签名和其他必要参数组装成统一的支付请求；</li><li>调用三方支付接口，发送支付请求；</li><li>接收并处理三方支付接口的响应结果；</li></ol><ul><li><strong>支付后置处理</strong></li></ul><p>支付后置处理主要是根据当前支付请求和三方支付的接口响应，落库记录支付订单信息，主要步骤如下：</p><ol><li>根据支付请求和三方支付接口响应结果，更新当前支付订单的状态、三方平台的交易流水号等信息；</li><li>如果当前订单是首次支付，则将订单信息插入数据库；否则，更新已有订单信息；</li><li>在支付订单落库的同时，添加订单超时触发器，将支付订单放入到延时队列中，延时任务的执行时间为订单的支付过期时间；</li><li>如果系统压测流量，根据实际情况调用 mockCallbackGateway 进行模拟回调；</li></ol><h3 id="_2-2-支付回调设计" tabindex="-1"><a class="header-anchor" href="#_2-2-支付回调设计"><span>2.2. 支付回调设计</span></a></h3><p>​ 第三方支付平台支付成功后，会回调支付中心，由支付中心系统进行统一处理后再回调业务商户系统，具体流程如图所示：</p><figure><img src="'+e+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>支付中心系统支付回调具体步骤如下：</p><ol><li><p>第三方支付平台通过HTTP请求通知支付中心支付结果，支付中心接收到请求后，校验回调的支付订单：</p><ul><li><p>如果订单已经被处理过，或者订单不存在，则直接返回处理结果；</p></li><li><p>如果订单存在且未被处理过，则校验商户信息、签名和金额；</p></li><li><p>如果验证不通过，则返回处理失败；如果验证通过，则更新订单状态，并异步回调商户系统通知支付结果；</p></li><li><p>如果回调商户系统失败，会放入延时队列，进行失败重试，如果回调商户系统成功，则修改支付订单表中支付回调状态</p></li></ul></li></ol><p>其中，支付中心在收到三方支付回调后异步回调商户系统，将三方支付与商户系统完全解耦，并在回调失败的24小时内不断重试，直至回调成功；</p><p>商户在接收到支付中心发送的回调后只需要处理自身后续逻辑即可，无需考虑安全效验等问题。</p><p><strong>支付核心状态通过CAS方式修改</strong>，解决并发情况下数据一致性问题。</p><p>对于回调商户通知结果现有两种方式，通过接口回调或通过kafka发送消息，选择哪种或两者皆由具体业务场景决定。</p><table><thead><tr><th><strong>方案</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th><th><strong>采用情况</strong></th></tr></thead><tbody><tr><td>接口回调</td><td>接入简单，不受内部服务限制</td><td>性能较低，存在丢失消息风险</td><td>本系统采用</td></tr><tr><td>消息队列</td><td>性能较高，保证消息一定能被消费</td><td>需调用方共同维护消息队列，且只能内部使用</td><td>否</td></tr></tbody></table><p>​ 退款模块主要负责处理商户发起的退款请求。退款流程依赖于支付功能，支持全额退款和部分退款，但无论何种退款，一个订单的退款金额总和不能超过支付金额。接入退款流程必须接入支付流程，退款功能依赖于支付功能。</p><p>整体执行顺序和模块主要包含三部分：</p><ol><li>退款请求校验：业务系统调用支付中心退款接口之后，支付中心校验商户信息、退款金额等，根据请求查询支付单信息和退款记录，查询是否已退款；</li><li>三方退款交互：支付中心根据支付类型选择对应的三方退款接口，生成接口交互签名，组装成统一的退款请求与三方支付交互；</li><li>退款后置处理：支付中心根据当前退款请求和三方接口响应，落库记录退款订单信息；</li></ol><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><strong>退款请求校验</strong></li></ul><ol><li>退款请求入参校验：对退款请求的字段进行校验，比如退款金额最多两位小数；</li><li>校验商户信息：支付中心从数据库中获取商户信息，并校验商户号、商户状态和交易类型等信息；</li><li>校验退款记录：查询支付订单，查询该订单的已退金额，查询退款记录，检查是否已经退款成功或正在退款中，做幂等处理，防止重复请求退款；</li></ol><p>​ 其中，一个退款请求后，除退款失败外，不能重复提交请求。**一笔退款失败后重新提交，请不要更换退款单号，请使用原商户退款单号。**退款记录表中的状态流转如图：</p><img src="'+r+'" style="zoom:50%;"><ul><li><strong>三方退款交互</strong></li></ul><p>支付中心根据支付类型，选择对应的三方支付接口，生成接口交互签名，组装成统一的退款请求与三方退款交互；</p><ul><li><strong>退款后置处理</strong></li></ul><p>退款后置处理主要是根据当前退款请求和三方退款的接口响应，落库记录退款订单信息；</p><p>ⅰ. 根据退款请求和三方退款接口响应结果，更新当前退款订单的退款状态；</p><p>ⅱ. 如果当前订单是首次退款，则将退款订单信息插入数据库；否则，更新已有退款订单信息；</p><h3 id="_2-4-退款回调设计" tabindex="-1"><a class="header-anchor" href="#_2-4-退款回调设计"><span>2.4. 退款回调设计</span></a></h3><p>​ 第三方支付平台退款成功后，会回调支付中心，由支付中心系统进行统一处理后再回调业务商户系统。退款回调的和支付回调类似，具体步骤如下：</p><ol><li>第三方支付平台通过HTTP请求通知支付中心退款结果，支付中心接收到请求后，根据配置的商户信息，对退款回调进行解密；</li><li>通过支付单号和退款单号查询退款记录，如果退款记录不存在或者退款回调已经处理过，则直接返回处理结果；</li><li>如果订单存在且未被处理过，则校验商户信息、签名和金额；</li><li>如果验证不通过，则返回处理失败；如果验证通过，则更新支付订单表记录，然后更新退款记录订单状态；</li><li>异步回调商户系统通知退款结果；如果回调商户系统失败，会放入延时队列，进行失败重试，直至回调成功，重复支付退款回调不进行通知商户；</li></ol><h3 id="_2-5-系统异常处理设计" tabindex="-1"><a class="header-anchor" href="#_2-5-系统异常处理设计"><span>2.5. 系统异常处理设计</span></a></h3><p>​ 异常分为两种，内部异常和外部异常，支付中心系统只能对内部异常进行处理，对于外部异常，如第三方支付返回结果异常，由业务商户系统进行处理。而对于支付系统内部异常，如非阻塞主流程的异常则放入异常队列，等待后续处理，如影响主流程异常，则抛出由商户处理。异常处理流程图如下：</p><img src="'+g+'" alt="系统异常处理设计" style="zoom:50%;"><ul><li><p>非阻塞主流程的异常：</p><ul><li>用户支付成功后，数据库异常导致修改支付订单状态失败，此等异常不应影响支付流程的进行，等待后续处理即可。</li></ul></li><li><p>回调后服务器异常</p><ul><li>退款成功后，修改数据库异常</li></ul></li></ul><h3 id="_2-6-数据库设计" tabindex="-1"><a class="header-anchor" href="#_2-6-数据库设计"><span>2.6 数据库设计</span></a></h3><h4 id="商户表-pay-merchant" tabindex="-1"><a class="header-anchor" href="#商户表-pay-merchant"><span>商户表（pay_merchant）</span></a></h4><table><thead><tr><th>字段名</th><th>描述</th></tr></thead><tbody><tr><td>merchant_no</td><td>支付系统商户号</td></tr><tr><td>platform</td><td>支付平台（微信支付宝华为等）</td></tr><tr><td>platform_merchant_no</td><td>支付平台商户号</td></tr><tr><td>app_id</td><td>支付平台appId</td></tr><tr><td>key_type</td><td>密钥类型</td></tr><tr><td>private_key</td><td>私钥</td></tr><tr><td>public_key</td><td>公钥，只有一个密钥时私钥公钥一致</td></tr><tr><td>del</td><td>是否已删除，0未删除，1已删除</td></tr><tr><td>create_time</td><td>创建时间</td></tr><tr><td>update_time</td><td>修改时间</td></tr></tbody></table><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pay_merchant</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">` (</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) unsigned </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> AUTO_INCREMENT COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;主键id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `merchant_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `platform`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付平台&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `platform_merchant_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付平台商户号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `app_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付平台appId&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `private_key`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;私钥&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `public_key`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;公钥，只有一个密钥时私钥公钥一致&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `del`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> tinyint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;是否被删除，0未删除，1已删除&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `create_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `update_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;最后一次修改时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> `merchant`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`merchant_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">InnoDB AUTO_INCREMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">93</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">utf8 COMMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户表&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="支付流水表-pay-order" tabindex="-1"><a class="header-anchor" href="#支付流水表-pay-order"><span>支付流水表（pay_order）</span></a></h4><table><thead><tr><th>字段名</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td>支付系统流水号</td></tr><tr><td>merchant_no</td><td>支付系统商户号</td></tr><tr><td>out_trade_no</td><td>商户订单号</td></tr><tr><td>pay_type</td><td>支付类型（微信 wxPay、支付宝 aliPay）</td></tr><tr><td>trade_type</td><td>交易类型（如微信支付的APP、jsapi支付等）</td></tr><tr><td>trade_amount</td><td>订单金额</td></tr><tr><td>true_amount</td><td>实付金额</td></tr><tr><td>pay_user_id</td><td>支付用户标识</td></tr><tr><td>notify_url</td><td>回调商户地址</td></tr><tr><td>platform_trade_no</td><td>支付平台交易流水号</td></tr><tr><td>pay_finish_time</td><td>订单完成时间</td></tr><tr><td>status</td><td>订单状态（0支付中，1支付成功，2支付关闭，3支付失败，4退款）</td></tr><tr><td>notify</td><td>支付回调状态（0未回调，1回调成功，2回调失败）</td></tr></tbody></table><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pay_order</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">` (</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) unsigned </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> AUTO_INCREMENT COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;主键id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `order_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付订单号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `merchant_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `out_trade_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户订单号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `pay_type`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> char</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付类型&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `trade_type`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;交易类型（如微信支付的APP、jsapi支付等）&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `trade_amount`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> decimal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;订单金额&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `true_amount`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> decimal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;实付金额&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `pay_user_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付用户标识&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `notify_url`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;回调商户地址&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `expire_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付超时时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `platform_trade_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> text</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付平台交易流水号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `pay_finish_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;订单完成时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `contract_order_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;签约订单id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `status`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> tinyint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;订单状态（0支付中，1支付成功，2支付失败，3支付关闭，4支付超时，5退款）&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `notify`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> tinyint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付回调状态（0未回调，1回调成功，2回调失败）&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `create_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `update_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;最后一次修改时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `merchant_id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">11</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户主键id快照&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  UNIQUE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> `orderNo`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`order_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  UNIQUE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> `idx`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`merchant_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`out_trade_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`pay_type`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> `expireTime`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`expire_time`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">InnoDB AUTO_INCREMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">952029</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">utf8 COMMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付订单表&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="退款记录表-refund-record" tabindex="-1"><a class="header-anchor" href="#退款记录表-refund-record"><span>退款记录表（refund_record）</span></a></h4><table><thead><tr><th>字段名</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td>退款id</td></tr><tr><td>pay_order_id</td><td>支付订单id</td></tr><tr><td>out_refund_no</td><td>商户退款号</td></tr><tr><td>refund_amount</td><td>退款金额</td></tr><tr><td>true_refund_amount</td><td>实际退款金额</td></tr><tr><td>refund_reason</td><td>退款原因</td></tr><tr><td>notify_url</td><td>回调地址</td></tr><tr><td>refund_finish_time</td><td>退款完成时间</td></tr><tr><td>platform_refund_no</td><td>支付平台平台退款号</td></tr><tr><td>status</td><td>退款状态（0初始化 1 退款中 2退款成功 3退款失败）</td></tr><tr><td>notify</td><td>退款回调状态（0 未回调 1回调成功 2回调失败）</td></tr></tbody></table><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> `</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">refund_record</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">` (</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `id`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) unsigned </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> AUTO_INCREMENT COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;主键id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `pay_order_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付订单id&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `out_refund_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;商户退款号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `refund_amount`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> decimal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款金额&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `true_refund_amount`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> decimal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;实际退款金额&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `refund_reason`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款原因&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `notify_url`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">256</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;回调地址&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `refund_finish_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> bigint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款完成时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `platform_refund_no`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> varchar</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">DEFAULT</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;支付平台平台退款号&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `status`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> tinyint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款状态（0初始化 1 退款中 2退款成功 3退款失败）&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `notify`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> tinyint</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">NOT NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款回调状态（0未回调 1回调成功 2回调失败）&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `create_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;创建时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">  `update_time`</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> timestamp</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> NOT NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> UPDATE</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CURRENT_TIMESTAMP COMMENT </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;最后一次修改时间&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  PRIMARY KEY</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">),</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">  UNIQUE</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> KEY</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;"> `idx`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`pay_order_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">`out_refund_no`</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) ENGINE</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">InnoDB AUTO_INCREMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">1079</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> DEFAULT</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> CHARSET</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">utf8 COMMENT</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&#39;退款记录表&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-熔断降级限流配置" tabindex="-1"><a class="header-anchor" href="#_2-7-熔断降级限流配置"><span>2.7 熔断降级限流配置</span></a></h3><p>对于服务的熔断降级的主流断路器有两种Sentinel和Hystrix</p><table><thead><tr><th>对比项</th><th>Sentinel</th><th>Hystrix</th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离（并发线程数限流）</td><td>线程池隔离/信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于响应时间、异常比率、异常数</td><td>基于异常比率</td></tr><tr><td>实时统计实现</td><td>滑动窗口（LeapArray）</td><td>滑动窗口（基于 RxJava）</td></tr><tr><td>动态规则配置</td><td>支持多种数据源</td><td>支持多种数据源</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td></tr><tr><td>基于注解的支持</td><td>支持</td><td>支持</td></tr><tr><td>限流</td><td>基于 QPS，支持基于调用关系的限流</td><td>有限的支持</td></tr><tr><td>流量整形</td><td>支持预热模式、匀速器模式、预热排队模式</td><td>不支持</td></tr><tr><td>系统自适应保护</td><td>支持</td><td>不支持</td></tr><tr><td>控制台</td><td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td><td>简单的监控查看</td></tr></tbody></table><h2 id="三-支付系统问题及解决方法" tabindex="-1"><a class="header-anchor" href="#三-支付系统问题及解决方法"><span>三. 支付系统问题及解决方法</span></a></h2><h3 id="_3-1-如何避免重复支付的问题" tabindex="-1"><a class="header-anchor" href="#_3-1-如何避免重复支付的问题"><span>3.1 如何避免重复支付的问题</span></a></h3><h3 id="_3-2-支付订单超时关闭的问题" tabindex="-1"><a class="header-anchor" href="#_3-2-支付订单超时关闭的问题"><span>3.2 支付订单超时关闭的问题</span></a></h3><h3 id="_3-3-如何防止支付掉单问题" tabindex="-1"><a class="header-anchor" href="#_3-3-如何防止支付掉单问题"><span>3.3 如何防止支付掉单问题</span></a></h3><h3 id="_3-4-如何保证支付结果实时性问题" tabindex="-1"><a class="header-anchor" href="#_3-4-如何保证支付结果实时性问题"><span>3.4 如何保证支付结果实时性问题</span></a></h3><h3 id="_3-5-商户号与多appid-问题" tabindex="-1"><a class="header-anchor" href="#_3-5-商户号与多appid-问题"><span>3.5 商户号与多appId 问题</span></a></h3><p>商户会有这样的需求，单个商户号希望能有多个appid进行支付（支付系统只支持单商户号对应多appId，不支持多对多关系）</p><p>微信</p><p>普通商户需要向微信申请 appid 以及 mchid。</p><p>同一个 mchid 可以绑定多个 appid，两者可以是同一个公司主体，也可以不同公司主体（限定资格开放）。mchid 最多可以绑定 50 个 appid；</p><p>同一个 appid 又可以被多个 mch id 绑定，所以 appid 与 mchid 原则上是多对多的关系。</p><p>这里需要注意，微信清算资金实际上是基于 mchid。即同一个 mchid，使用多个 appid 做交易，第二天资金是清算到 mchid 绑定的商户的账户。</p><p>支付宝</p><p>普通商户需要向支付宝申请入驻，将会得到商务号。接着需要创建应用得到 appid，上架成功后，需要进行签约。签约成功之后，这个 appid 与商户号建立唯一的绑定的关系。</p><p>同一个商户号可以绑定多个 appid，但是同一个 appid 只能绑定唯一个商户号。</p><p>支付宝的接口也可以看出，支付宝只要求传入 appid，后台肯定是跟库 appid 查找对应的商户号。所以简单而言 appid 与商户号是多对一的关系</p>',94)],y={},A=(0,a(9168).A)(y,[["render",function(i,s){return(0,t.uX)(),(0,t.CE)("div",null,B)}]]),D=JSON.parse('{"path":"/%E9%A1%B9%E7%9B%AE/%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F/%E6%94%AF%E4%BB%98%E6%B8%A0%E9%81%93%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9F.html","title":"支付渠道聚合系统","lang":"zh-CN","frontmatter":{"title":"支付渠道聚合系统","category":["项目"],"tag":["项目 支付系统"],"order":-10,"description":"支付系统设计--服务端 一. 背景 ​ 随着业务的快速发展与变化，业务模式由原有的独立 APP 售卖模式调整为以业务为导向，各业务百花齐放，各自建设业务系统模式。原有售卖模式采用的支付方式与独立 APP 耦合，且支付方式仅支持一个AppId，对应一个微信或支付宝商户号，无法满足各业务搭建 App 及独立售卖的模式。需要提供业务统一的支付平台能力，支持业...","head":[["meta",{"property":"og:url","content":"https://www.codenook.cn/%E9%A1%B9%E7%9B%AE/%E6%94%AF%E4%BB%98%E7%B3%BB%E7%BB%9F/%E6%94%AF%E4%BB%98%E6%B8%A0%E9%81%93%E8%81%9A%E5%90%88%E7%B3%BB%E7%BB%9F.html"}],["meta",{"property":"og:site_name","content":"知识体系"}],["meta",{"property":"og:title","content":"支付渠道聚合系统"}],["meta",{"property":"og:description","content":"支付系统设计--服务端 一. 背景 ​ 随着业务的快速发展与变化，业务模式由原有的独立 APP 售卖模式调整为以业务为导向，各业务百花齐放，各自建设业务系统模式。原有售卖模式采用的支付方式与独立 APP 耦合，且支付方式仅支持一个AppId，对应一个微信或支付宝商户号，无法满足各业务搭建 App 及独立售卖的模式。需要提供业务统一的支付平台能力，支持业..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-16T10:34:43.000Z"}],["meta",{"property":"article:author","content":"XIONG XUECHUN"}],["meta",{"property":"article:tag","content":"项目 支付系统"}],["meta",{"property":"article:modified_time","content":"2024-12-16T10:34:43.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"支付渠道聚合系统\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-12-16T10:34:43.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"XIONG XUECHUN\\",\\"url\\":\\"https://www.codenook.cn/\\",\\"email\\":\\"15293191747@163.com\\"}]}"]]},"headers":[{"level":2,"title":"1. 业务架构","slug":"_1-业务架构","link":"#_1-业务架构","children":[]},{"level":2,"title":"2. 极简支付流程","slug":"_2-极简支付流程","link":"#_2-极简支付流程","children":[]},{"level":2,"title":"1. 系统架构设计","slug":"_1-系统架构设计","link":"#_1-系统架构设计","children":[]},{"level":2,"title":"2. 详细设计","slug":"_2-详细设计","link":"#_2-详细设计","children":[{"level":3,"title":"2.1. 支付模块设计","slug":"_2-1-支付模块设计","link":"#_2-1-支付模块设计","children":[]},{"level":3,"title":"2.2. 支付回调设计","slug":"_2-2-支付回调设计","link":"#_2-2-支付回调设计","children":[]},{"level":3,"title":"2.4. 退款回调设计","slug":"_2-4-退款回调设计","link":"#_2-4-退款回调设计","children":[]},{"level":3,"title":"2.5. 系统异常处理设计","slug":"_2-5-系统异常处理设计","link":"#_2-5-系统异常处理设计","children":[]},{"level":3,"title":"2.6 数据库设计","slug":"_2-6-数据库设计","link":"#_2-6-数据库设计","children":[]},{"level":3,"title":"2.7 熔断降级限流配置","slug":"_2-7-熔断降级限流配置","link":"#_2-7-熔断降级限流配置","children":[]}]},{"level":2,"title":"三. 支付系统问题及解决方法","slug":"三-支付系统问题及解决方法","link":"#三-支付系统问题及解决方法","children":[{"level":3,"title":"3.1 如何避免重复支付的问题","slug":"_3-1-如何避免重复支付的问题","link":"#_3-1-如何避免重复支付的问题","children":[]},{"level":3,"title":"3.2 支付订单超时关闭的问题","slug":"_3-2-支付订单超时关闭的问题","link":"#_3-2-支付订单超时关闭的问题","children":[]},{"level":3,"title":"3.3 如何防止支付掉单问题","slug":"_3-3-如何防止支付掉单问题","link":"#_3-3-如何防止支付掉单问题","children":[]},{"level":3,"title":"3.4 如何保证支付结果实时性问题","slug":"_3-4-如何保证支付结果实时性问题","link":"#_3-4-如何保证支付结果实时性问题","children":[]},{"level":3,"title":"3.5 商户号与多appId 问题","slug":"_3-5-商户号与多appid-问题","link":"#_3-5-商户号与多appid-问题","children":[]}]}],"git":{"createdTime":1726223192000,"updatedTime":1734345283000,"contributors":[{"name":"xiongxc","email":"xiongxc@rd.netease.com","commits":4}]},"readingTime":{"minutes":19.03,"words":5710},"filePathRelative":"项目/支付系统/支付渠道聚合系统.md","localizedDate":"2024年9月13日","excerpt":"\\n<h1>一. 背景</h1>\\n<p>​\\t随着业务的快速发展与变化，业务模式由原有的独立 APP 售卖模式调整为以业务为导向，各业务百花齐放，各自建设业务系统模式。原有售卖模式采用的支付方式与独立 APP 耦合，且支付方式仅支持一个AppId，对应一个微信或支付宝商户号，无法满足各业务搭建 App 及独立售卖的模式。需要提供业务统一的支付平台能力，支持业务与支付中心一次对接，即可打通支付整体流程。</p>\\n<p>支付中心在现代企业中扮演着至关重要的角色，它不仅是内部业务线之间的支付服务提供者，还是与外部三方支付机构或银行之间的资金流转的桥梁，有助于实现支付流程的标准化、高效化和安全化。</p>","autoDesc":true}')}}]);